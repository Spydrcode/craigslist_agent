<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forecasta Lead Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: white;
            padding: 20px 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            color: #1a1a2e;
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .subtitle {
            color: #666;
            font-size: 0.95em;
        }

        /* Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 20px;
            align-items: start;
        }

        /* Search Panel */
        .search-panel {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 20px;
        }

        .search-panel h2 {
            color: #1a1a2e;
            font-size: 1.3em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #333;
            font-weight: 500;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95em;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Results Area */
        .results-area {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .results-header h2 {
            color: #1a1a2e;
            font-size: 1.3em;
        }

        .results-count {
            color: #667eea;
            font-weight: 600;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Job Cards */
        .job-grid {
            display: grid;
            gap: 15px;
        }

        .job-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .job-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }

        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .job-title {
            font-size: 1.15em;
            font-weight: 600;
            color: #1a1a2e;
            margin-bottom: 5px;
        }

        .job-company {
            color: #667eea;
            font-weight: 500;
        }

        .job-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 12px;
            font-size: 0.9em;
            color: #666;
        }

        .job-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .job-description {
            color: #555;
            line-height: 1.5;
            margin-bottom: 15px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .job-actions {
            display: flex;
            gap: 10px;
        }

        .btn-add {
            background: #10b981;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-add:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .btn-view {
            background: #3b82f6;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-view:hover {
            background: #2563eb;
        }

        .btn-dismiss {
            background: #ef4444;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-dismiss:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 1.3em;
            margin-bottom: 10px;
            color: #333;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .modal-header h2 {
            color: #1a1a2e;
            font-size: 1.5em;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }

        .close-btn:hover {
            color: #333;
        }

        .analysis-section {
            margin-bottom: 25px;
        }

        .analysis-section h3 {
            color: #667eea;
            font-size: 1.1em;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        .tier-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .tier-1 { background: #d1fae5; color: #065f46; }
        .tier-2 { background: #dbeafe; color: #1e40af; }
        .tier-3 { background: #fef3c7; color: #92400e; }
        .tier-4 { background: #fee2e2; color: #991b1b; }
        .tier-5 { background: #f3f4f6; color: #374151; }

        .score-display {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .info-item {
            background: #f9fafb;
            padding: 12px;
            border-radius: 6px;
        }

        .info-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .info-value {
            color: #1a1a2e;
            font-weight: 500;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .help-text {
            font-size: 0.85em;
            color: #666;
            margin-top: 4px;
        }

        /* Agent Cards */
        .agents-section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .agents-section h2 {
            color: #1a1a2e;
            font-size: 1.3em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .agents-toggle {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: auto;
        }

        .agents-toggle:hover {
            background: #5568d3;
        }

        .agents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .agent-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #ffffff 100%);
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s;
            position: relative;
        }

        .agent-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .agent-card.initialized {
            border-color: #10b981;
        }

        .agent-card.agent-running {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #dbeafe 0%, #ffffff 100%);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
            animation: pulse-border 2s infinite;
        }

        .agent-card.agent-completed {
            border-color: #10b981;
            background: linear-gradient(135deg, #d1fae5 0%, #ffffff 100%);
        }

        @keyframes pulse-border {
            0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
            50% { box-shadow: 0 0 30px rgba(59, 130, 246, 0.6); }
        }

        .agent-card.openai-enhanced {
            background: linear-gradient(135deg, #fef3c7 0%, #ffffff 100%);
            border-color: #f59e0b;
        }

        .agent-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .agent-emoji {
            font-size: 1.8em;
        }

        .agent-info {
            flex: 1;
        }

        .agent-name {
            font-weight: 600;
            color: #1a1a2e;
            font-size: 0.95em;
        }

        .agent-category {
            font-size: 0.75em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .agent-description {
            font-size: 0.85em;
            color: #555;
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .agent-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .agent-status.active {
            color: #10b981;
        }

        .agent-status.inactive {
            color: #9ca3af;
        }

        .agent-feature-badge {
            background: #f59e0b;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: 600;
            margin-top: 8px;
            display: inline-block;
        }

        .category-section {
            margin-bottom: 20px;
        }

        .category-section h3 {
            color: #667eea;
            font-size: 1em;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }

        .agents-collapsed {
            display: none;
        }

        /* Real-Time Progress Widget */
        .progress-widget {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
            margin-bottom: 20px;
            color: white;
            display: none;
        }

        .progress-widget.active {
            display: block;
        }

        .progress-widget h3 {
            font-size: 1.2em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-widget .pulse {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
        }

        .overall-progress-bar {
            background: rgba(255,255,255,0.3);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .overall-progress-fill {
            background: #4ade80;
            height: 100%;
            transition: width 0.3s ease;
        }

        .agent-progress-list {
            margin-top: 15px;
            display: grid;
            gap: 10px;
        }

        .agent-progress-item {
            background: rgba(255,255,255,0.15);
            padding: 12px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .agent-progress-item.running {
            background: rgba(255,255,255,0.25);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .agent-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .agent-progress-name {
            font-weight: 600;
            font-size: 0.95em;
        }

        .agent-progress-percentage {
            font-size: 0.85em;
            opacity: 0.9;
        }

        .agent-progress-bar {
            background: rgba(255,255,255,0.3);
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
        }

        .agent-progress-bar-fill {
            background: #4ade80;
            height: 100%;
            transition: width 0.3s ease;
        }

        .agent-progress-message {
            font-size: 0.85em;
            margin-top: 6px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>üéØ Forecasta Lead Generator</h1>
                <p class="subtitle">Search Craigslist jobs and convert to qualified leads</p>
            </div>
            <div>
                <a href="/clients" class="btn btn-primary" style="text-decoration: none;">üë• View Clients</a>
            </div>
        </header>

        <!-- Agents Section -->
        <div class="agents-section">
            <h2>
                ü§ñ AI Agent Status
                <button class="agents-toggle" onclick="toggleAgents()">Show All Agents</button>
            </h2>
            <div id="agentsContainer" class="agents-collapsed">
                <div id="agentsGrid"></div>
            </div>
        </div>

        <!-- OpenAI Features Section -->
        <div class="agents-section" style="background: linear-gradient(135deg, #fef3c7 0%, #ffffff 100%); border: 2px solid #f59e0b;">
            <h2>
                ‚ö° OpenAI Advanced Features
                <button class="agents-toggle" onclick="toggleFeatures()" style="background: #f59e0b;">Show Features</button>
            </h2>
            <div id="featuresContainer" class="agents-collapsed">
                <div class="agents-grid">
                    <div class="agent-card openai-enhanced">
                        <div class="agent-card-header">
                            <div class="agent-emoji">üí¨</div>
                            <div class="agent-info">
                                <div class="agent-name">Conversation State API</div>
                                <div class="agent-category">Chat Enhancement</div>
                            </div>
                        </div>
                        <div class="agent-description">
                            Stateful conversations with 58% token reduction. Maintains context across multiple interactions.
                        </div>
                        <div class="agent-status active">‚óè Available</div>
                        <div class="agent-feature-badge">58% Token Savings</div>
                    </div>

                    <div class="agent-card openai-enhanced">
                        <div class="agent-card-header">
                            <div class="agent-emoji">üì¶</div>
                            <div class="agent-info">
                                <div class="agent-name">Batch API</div>
                                <div class="agent-category">Bulk Processing</div>
                            </div>
                        </div>
                        <div class="agent-description">
                            Process multiple leads asynchronously with 50% cost reduction. Perfect for bulk enrichment.
                        </div>
                        <div class="agent-status active">‚óè Available</div>
                        <div class="agent-feature-badge">50% Cost Savings</div>
                    </div>

                    <div class="agent-card openai-enhanced">
                        <div class="agent-card-header">
                            <div class="agent-emoji">üß†</div>
                            <div class="agent-info">
                                <div class="agent-name">Deep Research</div>
                                <div class="agent-category">Advanced Analysis</div>
                            </div>
                        </div>
                        <div class="agent-description">
                            Powered by o3 and o4-mini models. Deep company research and competitive intelligence.
                        </div>
                        <div class="agent-status active">‚óè Available</div>
                        <div class="agent-feature-badge">o3/o4-mini Models</div>
                    </div>

                    <div class="agent-card openai-enhanced">
                        <div class="agent-card-header">
                            <div class="agent-emoji">üîå</div>
                            <div class="agent-info">
                                <div class="agent-name">MCP Integration</div>
                                <div class="agent-category">Tool Orchestration</div>
                            </div>
                        </div>
                        <div class="agent-description">
                            Model Context Protocol with auto-start server. Seamless tool integration via Responses API.
                        </div>
                        <div class="agent-status active">‚óè Auto-Managed</div>
                        <div class="agent-feature-badge">Zero Config</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Real-Time Progress Widget -->
        <div id="progressWidget" class="progress-widget">
            <h3>
                <span class="pulse"></span>
                Processing Jobs - Real-Time Status
            </h3>
            <div class="overall-progress-bar">
                <div id="overallProgressFill" class="overall-progress-fill" style="width: 0%"></div>
            </div>
            <div style="margin-top: 10px; font-size: 0.9em;" id="overallStatus">Starting...</div>
            <div id="agentProgressList" class="agent-progress-list"></div>
        </div>

        <div class="main-layout">
            <!-- Search Panel -->
            <div class="search-panel">
                <h2>üîç Search Jobs</h2>
                
                <form id="searchForm">
                    <div class="form-group">
                        <label for="city">City / Region *</label>
                        <input type="text" id="citySearch" placeholder="Search cities..." style="margin-bottom: 8px;">
                        <select id="city" required>
                            <option value="">Loading cities...</option>
                        </select>
                        <p class="help-text" id="cityInfo">Select the Craigslist region to search</p>
                    </div>

                    <div class="form-group">
                        <label for="category">Category *</label>
                        <input type="text" id="categorySearch" placeholder="Search categories..." style="margin-bottom: 8px;">
                        <select id="category" required>
                            <option value="">Loading categories...</option>
                        </select>
                        <p class="help-text">WARNING: "All Jobs" returns 300+ jobs/page. Use specific categories (e.g., Software, Tech Support) for faster, targeted results.</p>
                    </div>

                    <div class="form-group">
                        <label for="keywords">Keywords (Optional)</label>
                        <input type="text" id="keywords" placeholder="e.g., construction, roofing, contractor">
                        <p class="help-text">Comma-separated keywords to filter</p>
                    </div>

                    <div class="form-group">
                        <label for="maxPages">Max Pages</label>
                        <input type="number" id="maxPages" value="2" min="1" max="10">
                        <p class="help-text">Specific categories: ~120 jobs/page. "All Jobs": ~300 jobs/page. Start with 1-2 pages.</p>
                    </div>

                    <button type="submit" class="btn btn-primary" id="searchBtn">
                        üöÄ Search Jobs
                    </button>
                </form>

                <div id="searchStatus" style="margin-top: 15px; font-size: 0.9em; color: #666;"></div>
            </div>

            <!-- Results Area -->
            <div class="results-area">
                <div class="results-header">
                    <h2>Job Results</h2>
                    <span class="results-count" id="resultsCount">0 jobs found</span>
                </div>

                <div id="resultsContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <h3>No jobs yet</h3>
                        <p>Use the search panel to find Craigslist jobs</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lead Analysis Modal -->
    <div id="analysisModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Lead Analysis</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="analysisContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Analyzing lead...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentJobs = [];
        let allLocations = [];
        let allCategories = [];
        let agentsExpanded = false;
        let progressWebSocket = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadCraigslistLocations();
            loadCraigslistCategories();
            loadAgentStatus();
            initializeWebSocket();

            // Restore previous search results from sessionStorage if available
            const savedResults = sessionStorage.getItem('searchResults');
            if (savedResults) {
                try {
                    const jobs = JSON.parse(savedResults);
                    if (jobs && jobs.length > 0) {
                        console.log('üîÑ Restoring', jobs.length, 'jobs from previous search');
                        displayJobs(jobs);
                    }
                } catch (e) {
                    console.error('Failed to restore search results:', e);
                }
            }
        });

        // Initialize WebSocket for real-time progress
        function initializeWebSocket() {
            try {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/progress`;
                progressWebSocket = new WebSocket(wsUrl);
                
                progressWebSocket.onmessage = (event) => {
                    const progress = JSON.parse(event.data);
                    updateProgressWidget(progress);
                };
                
                progressWebSocket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };
                
                progressWebSocket.onclose = () => {
                    // Reconnect after 3 seconds
                    setTimeout(initializeWebSocket, 3000);
                };
            } catch (error) {
                console.error('Failed to initialize WebSocket:', error);
            }
        }

        // Update progress widget with real-time data
        function updateProgressWidget(message) {
            const widget = document.getElementById('progressWidget');
            const overallFill = document.getElementById('overallProgressFill');
            const overallStatus = document.getElementById('overallStatus');
            const agentList = document.getElementById('agentProgressList');

            // Check if elements exist
            if (!widget || !overallFill || !overallStatus || !agentList) {
                console.warn('Progress widget elements not found');
                return;
            }

            // Extract data from WebSocket message format: {type: 'progress', data: {...}}
            const progressData = message.data || message;

            if (progressData && progressData.agents && progressData.agents.length > 0) {
                // Show widget when we have agent data
                widget.classList.add('active');
                widget.style.display = 'block';

                // Update overall progress bar
                const percentage = Math.round(progressData.overall_progress || 0);
                overallFill.style.width = `${percentage}%`;
                overallStatus.textContent = `${progressData.completed_agents || 0}/${progressData.total_agents || 0} agents complete (${percentage}%)`;

                // Update agent list
                agentList.innerHTML = progressData.agents.map(agent => {
                    const agentPercentage = Math.round(agent.progress || 0);
                    const statusClass = agent.status === 'running' ? 'running' : agent.status === 'completed' ? 'completed' : '';
                    const statusEmoji = agent.status === 'completed' ? '‚úÖ' : agent.status === 'running' ? '‚è≥' : agent.status === 'failed' ? '‚ùå' : '‚è∏Ô∏è';

                    return `
                        <div class="agent-progress-item ${statusClass}">
                            <div class="agent-progress-header">
                                <div class="agent-progress-name">${statusEmoji} ${agent.name}</div>
                                <div class="agent-progress-percentage">${agentPercentage}%</div>
                            </div>
                            <div class="agent-progress-bar">
                                <div class="agent-progress-bar-fill" style="width: ${agentPercentage}%"></div>
                            </div>
                            ${agent.message ? `<div class="agent-progress-message">${agent.message}</div>` : ''}
                        </div>
                    `;
                }).join('');

                // Update agent cards with real-time progress
                updateAgentCards(progressData);
            } else {
                // No active progress - hide widget
                widget.classList.remove('active');
                overallFill.style.width = '0%';
                overallStatus.textContent = 'Starting...';
                agentList.innerHTML = '';
            }
        }

        // Toggle agents section
        function toggleAgents() {
            agentsExpanded = !agentsExpanded;
            const container = document.getElementById('agentsContainer');
            const button = document.querySelector('.agents-toggle');
            
            if (agentsExpanded) {
                container.classList.remove('agents-collapsed');
                button.textContent = 'Hide Agents';
            } else {
                container.classList.add('agents-collapsed');
                button.textContent = 'Show All Agents';
            }
        }

        // Toggle features section
        function toggleFeatures() {
            const container = document.getElementById('featuresContainer');
            const button = document.querySelectorAll('.agents-toggle')[1];
            const isExpanded = !container.classList.contains('agents-collapsed');
            
            if (isExpanded) {
                container.classList.add('agents-collapsed');
                button.textContent = 'Show Features';
            } else {
                container.classList.remove('agents-collapsed');
                button.textContent = 'Hide Features';
            }
        }

        // Load and display agent status
        async function loadAgentStatus() {
            try {
                const response = await fetch('/api/agents/status');
                const data = await response.json();
                
                if (data.agents) {
                    displayAgents(data.agents);
                }
            } catch (error) {
                console.error('Error loading agent status:', error);
            }
        }

        // Store current agents data globally for updates
        let currentAgentsData = {};

        // Display agents organized by category
        function displayAgents(agents) {
            currentAgentsData = agents; // Store for later updates
            const container = document.getElementById('agentsGrid');

            const categories = {
                'core': { name: 'Core Agents', agents: [] },
                'analysis': { name: 'Analysis & Research', agents: [] },
                'engagement': { name: 'Engagement', agents: [] },
                'openai': { name: 'OpenAI Enhanced', agents: [] }
            };

            // Group agents by category
            Object.entries(agents).forEach(([key, agent]) => {
                if (categories[agent.category]) {
                    categories[agent.category].agents.push({ key, ...agent });
                }
            });

            // Build HTML for each category
            let html = '';
            Object.entries(categories).forEach(([catKey, category]) => {
                if (category.agents.length > 0) {
                    html += `
                        <div class="category-section">
                            <h3>${category.name}</h3>
                            <div class="agents-grid">
                    `;

                    category.agents.forEach(agent => {
                        const isOpenAI = agent.category === 'openai';
                        const statusClass = agent.initialized ? 'active' : 'inactive';
                        const statusText = agent.initialized ? '‚óè Active' : '‚óã Inactive';
                        const cardClass = isOpenAI ? 'agent-card openai-enhanced' :
                                         agent.initialized ? 'agent-card initialized' : 'agent-card';

                        html += `
                            <div class="${cardClass}" data-agent-key="${agent.key}">
                                <div class="agent-card-header">
                                    <div class="agent-emoji">${agent.emoji}</div>
                                    <div class="agent-info">
                                        <div class="agent-name">${formatAgentName(agent.key)}</div>
                                        <div class="agent-category">${agent.category}</div>
                                    </div>
                                </div>
                                <div class="agent-description">${agent.description}</div>
                                <div class="agent-status ${statusClass}" data-status-element="true">${statusText}</div>
                                <div class="agent-progress-bar" style="display: none; margin-top: 10px; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px;">
                                    <div class="agent-progress-fill" style="width: 0%; height: 100%; background: #10b981; border-radius: 2px; transition: width 0.3s;"></div>
                                </div>
                                ${agent.feature ? `<div class="agent-feature-badge">${agent.feature}</div>` : ''}
                            </div>
                        `;
                    });

                    html += `
                            </div>
                        </div>
                    `;
                }
            });

            container.innerHTML = html;
        }

        // Update agent cards with real-time progress
        function updateAgentCards(progressData) {
            if (!progressData || !progressData.agents) return;

            // Reset all agents to idle state first
            document.querySelectorAll('[data-agent-key]').forEach(card => {
                const statusEl = card.querySelector('[data-status-element]');
                const progressBar = card.querySelector('.agent-progress-bar');
                const progressFill = card.querySelector('.agent-progress-fill');

                if (statusEl && progressBar && progressFill) {
                    // Reset to initialized state
                    statusEl.className = 'agent-status inactive';
                    statusEl.textContent = '‚óã Idle';
                    progressBar.style.display = 'none';
                    progressFill.style.width = '0%';
                    card.classList.remove('agent-running', 'agent-completed');
                }
            });

            // Update agents with current progress
            progressData.agents.forEach(agent => {
                // Try to match agent name to card
                const agentKey = agent.name.toLowerCase().replace(/\s+/g, '_').replace('agent', '').replace(/_$/, '').trim();
                const card = document.querySelector(`[data-agent-key*="${agentKey}"]`);

                if (card) {
                    const statusEl = card.querySelector('[data-status-element]');
                    const progressBar = card.querySelector('.agent-progress-bar');
                    const progressFill = card.querySelector('.agent-progress-fill');

                    if (agent.status === 'running') {
                        statusEl.className = 'agent-status active';
                        statusEl.textContent = '‚è≥ Running';
                        progressBar.style.display = 'block';
                        progressFill.style.width = `${Math.round(agent.progress || 0)}%`;
                        card.classList.add('agent-running');
                    } else if (agent.status === 'completed') {
                        statusEl.className = 'agent-status active';
                        statusEl.textContent = '‚úÖ Completed';
                        progressBar.style.display = 'block';
                        progressFill.style.width = '100%';
                        card.classList.add('agent-completed');
                    } else if (agent.status === 'failed') {
                        statusEl.className = 'agent-status inactive';
                        statusEl.textContent = '‚ùå Failed';
                        progressBar.style.display = 'none';
                    } else if (agent.status === 'pending') {
                        statusEl.className = 'agent-status inactive';
                        statusEl.textContent = '‚è∏Ô∏è Pending';
                        progressBar.style.display = 'none';
                    }
                }
            });
        }

        // Format agent key to readable name
        function formatAgentName(key) {
            return key
                .split('_')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        // Load all Craigslist locations
        async function loadCraigslistLocations() {
            try {
                const response = await fetch('/api/craigslist/locations/flat');
                const data = await response.json();

                if (data.success) {
                    allLocations = data.locations;
                    populateCitySelect(allLocations);
                    console.log(`Loaded ${allLocations.length} Craigslist cities`);
                }
            } catch (error) {
                console.error('Error loading locations:', error);
                // Fallback to basic cities
                document.getElementById('city').innerHTML = `
                    <option value="">Select a city...</option>
                    <option value="sfbay">San Francisco Bay Area</option>
                    <option value="newyork">New York City</option>
                    <option value="losangeles">Los Angeles</option>
                `;
            }
        }

        // Populate city select with optgroups by state
        function populateCitySelect(locations) {
            const select = document.getElementById('city');
            select.innerHTML = '<option value="">Select a city...</option>';

            // Group by state
            const grouped = {};
            locations.forEach(loc => {
                const state = loc.state || 'Other';
                if (!grouped[state]) grouped[state] = [];
                grouped[state].push(loc);
            });

            // Add optgroups sorted by state
            Object.keys(grouped).sort().forEach(state => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = state;

                grouped[state].forEach(loc => {
                    const option = document.createElement('option');
                    option.value = loc.code;
                    option.textContent = `${loc.name}`;
                    option.dataset.state = loc.state;
                    option.dataset.country = loc.country;
                    optgroup.appendChild(option);
                });

                select.appendChild(optgroup);
            });
        }

        // City search filter
        document.getElementById('citySearch').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            if (!query) {
                populateCitySelect(allLocations);
                return;
            }

            const filtered = allLocations.filter(loc =>
                loc.name.toLowerCase().includes(query) ||
                loc.code.toLowerCase().includes(query) ||
                (loc.state && loc.state.toLowerCase().includes(query))
            );
            populateCitySelect(filtered);
        });

        // Show city info when selected
        document.getElementById('city').addEventListener('change', (e) => {
            const selected = e.target.selectedOptions[0];
            if (selected && selected.dataset.state) {
                document.getElementById('cityInfo').textContent =
                    `${selected.dataset.state}, ${selected.dataset.country}`;
            } else {
                document.getElementById('cityInfo').textContent =
                    'Select the Craigslist region to search';
            }
        });

        // Load all job categories
        async function loadCraigslistCategories() {
            try {
                const response = await fetch('/api/craigslist/categories');
                const data = await response.json();

                if (data.success) {
                    allCategories = data.categories;
                    populateCategorySelect(allCategories);
                    console.log(`Loaded ${allCategories.length} job categories`);
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // Populate category select
        function populateCategorySelect(categories) {
            const select = document.getElementById('category');
            select.innerHTML = '<option value="">Select a category...</option>';

            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.code;
                option.textContent = cat.name;
                select.appendChild(option);
            });
        }

        // Category search filter
        document.getElementById('categorySearch').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            if (!query) {
                populateCategorySelect(allCategories);
                return;
            }

            const filtered = allCategories.filter(cat =>
                cat.name.toLowerCase().includes(query) ||
                cat.code.toLowerCase().includes(query)
            );
            populateCategorySelect(filtered);
        });

        // Search form submission
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const city = document.getElementById('city').value;
            const category = document.getElementById('category').value;
            const keywords = document.getElementById('keywords').value;
            const maxPages = parseInt(document.getElementById('maxPages').value);

            if (!city || !category) {
                alert('Please select both city and category');
                return;
            }

            const searchBtn = document.getElementById('searchBtn');
            const statusDiv = document.getElementById('searchStatus');
            
            // Show progress widget
            const progressWidget = document.getElementById('progressWidget');
            if (progressWidget) {
                progressWidget.style.display = 'block';
            }
            
            searchBtn.disabled = true;
            searchBtn.textContent = 'Searching...';
            statusDiv.textContent = 'Scraping Craigslist...';
            
            console.log('Sending request with:', {city, category, keywords, maxPages});

            try {
                const payload = {
                    city: city,
                    category: category,
                    max_pages: maxPages
                };

                if (keywords.trim()) {
                    payload.keywords = keywords.split(',').map(k => k.trim());
                }

                const response = await fetch('/api/scrape', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                console.log('Response received:', response.status, response.statusText);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response body:', errorText);
                    throw new Error(`Server returned ${response.status}: ${errorText}`);
                }

                const data = await response.json();

                console.log('‚úÖ Response data received:', data);
                console.log('  - success:', data.success);
                console.log('  - jobs count:', data.jobs ? data.jobs.length : 'undefined');
                console.log('  - jobs array:', data.jobs);

                if (data.success && data.jobs) {
                    // Got results directly from scrape!
                    statusDiv.textContent = `‚úÖ Found ${data.jobs.length} qualified prospects from ${data.total_scraped} jobs scraped!`;
                    statusDiv.style.color = '#10b981';
                    searchBtn.disabled = false;
                    searchBtn.textContent = 'üöÄ Search Jobs';

                    // Hide progress widget
                    const progressWidget = document.getElementById('progressWidget');
                    if (progressWidget) {
                        progressWidget.style.display = 'none';
                    }

                    // Display the jobs immediately
                    console.log('üìã Calling displayJobs with', data.jobs.length, 'jobs');
                    displayJobs(data.jobs);
                } else {
                    statusDiv.textContent = `Error: ${data.error || 'Search failed'}`;
                    statusDiv.style.color = '#ef4444';
                    
                    // Hide progress widget on error
                    const progressWidget = document.getElementById('progressWidget');
                    if (progressWidget) {
                        progressWidget.style.display = 'none';
                    }
                    
                    displayProspects([]);
                }
            } catch (error) {
                console.error('Search error:', error);
                statusDiv.textContent = `Error: ${error.message}`;
                statusDiv.style.color = '#ef4444';
                
                // Hide progress widget on error
                const progressWidget = document.getElementById('progressWidget');
                if (progressWidget) {
                    progressWidget.style.display = 'none';
                }
                
                displayProspects([]);
                searchBtn.disabled = false;
                searchBtn.textContent = 'üöÄ Search Jobs';
            }
        });

        function displayProspects(prospects) {
            // Store prospects globally so addAsClient can access them
            currentJobs = prospects;

            const container = document.getElementById('resultsContainer');
            const countEl = document.getElementById('resultsCount');

            countEl.textContent = `${prospects.length} qualified prospects found`;

            if (prospects.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üòï</div>
                        <h3>No qualified prospects found</h3>
                        <p>Try adjusting your search criteria or choosing a different category</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead style="background: #f8f9fa;">
                        <tr>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0;">Company</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0;">Score</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0;">Priority</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0;">Growth</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0;">Jobs</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${prospects.map(p => `
                            <tr style="border-bottom: 1px solid #f0f0f0;">
                                <td style="padding: 12px;"><strong>${escapeHtml(p.company_name || 'Unknown')}</strong></td>
                                <td style="padding: 12px;"><span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 12px; border-radius: 12px; font-weight: 600;">${Math.round(p.lead_score || 0)}</span></td>
                                <td style="padding: 12px;"><span class="priority-badge priority-${(p.priority_tier || 'low').toLowerCase()}">${p.priority_tier || 'LOW'}</span></td>
                                <td style="padding: 12px;">${Math.round((p.growth_score || 0) * 100)}%</td>
                                <td style="padding: 12px;">${p.posting_count || 0}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function displayJobs(jobs) {
            console.log('üéØ displayJobs called with', jobs.length, 'jobs');
            console.log('Sample job data:', jobs[0]);

            // Store jobs globally so addAsClient can access them
            currentJobs = jobs;

            // Also store in sessionStorage so results persist across page navigation
            sessionStorage.setItem('searchResults', JSON.stringify(jobs));

            console.log('‚úÖ currentJobs set to', currentJobs.length, 'items');

            const container = document.getElementById('resultsContainer');
            const countEl = document.getElementById('resultsCount');

            countEl.textContent = `${jobs.length} qualified jobs found`;

            if (jobs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üòï</div>
                        <h3>No qualified jobs found</h3>
                        <p>Try adjusting your search criteria or choosing a different category</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="job-grid">
                    ${jobs.map((job, index) => `
                        <div class="job-card" style="border-left: 4px solid ${getScoreColor(job.qualification_score || 0)}">
                            <div class="job-header">
                                <div style="flex: 1;">
                                    <div class="job-title">${escapeHtml(job.title || 'Untitled')}</div>
                                    ${job.company ? `<div class="job-company">${escapeHtml(job.company)}</div>` : ''}
                                    ${job.qualification_score ? `
                                        <div style="margin-top: 8px;">
                                            <span style="background: ${getScoreColor(job.qualification_score)}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">
                                                Match: ${job.qualification_score}%
                                            </span>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            ${job.qualification_reason ? `
                                <div style="background: #f0f9ff; padding: 10px; border-radius: 6px; margin: 12px 0; font-size: 0.9em; color: #0369a1;">
                                    ‚ú® ${escapeHtml(job.qualification_reason)}
                                </div>
                            ` : ''}
                            
                            <div class="job-meta">
                                ${job.location ? `<span>üìç ${escapeHtml(job.location)}</span>` : ''}
                                ${job.date ? `<span>üìÖ ${escapeHtml(job.date)}</span>` : ''}
                                ${job.compensation ? `<span>üí∞ ${escapeHtml(job.compensation)}</span>` : ''}
                            </div>

                            <div class="job-description">
                                ${escapeHtml(job.description ? job.description.substring(0, 200) : 'No description')}...
                            </div>

                            <div class="job-actions">
                                <button class="btn-add" onclick="addAsClient(${index})">
                                    ‚ûï Add as Client
                                </button>
                                ${job.url ? `<button class="btn-view" onclick="window.open('${job.url}', '_blank')">üîó View Original</button>` : ''}
                                <button class="btn-dismiss" onclick="dismissJob(${index})">
                                    üóëÔ∏è Dismiss
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function getScoreColor(score) {
            if (score >= 80) return '#10b981'; // Green
            if (score >= 60) return '#3b82f6'; // Blue
            if (score >= 40) return '#f59e0b'; // Orange
            return '#6b7280'; // Gray
        }

        function dismissJob(index) {
            const job = currentJobs[index];

            if (!job) {
                console.error(`Job not found at index ${index}`);
                return;
            }

            // Confirm dismissal
            const companyName = job.company || 'this company';
            if (!confirm(`Dismiss ${companyName}? This will remove it from the current results.`)) {
                return;
            }

            // Remove job from current array
            currentJobs.splice(index, 1);

            // Re-render the results
            displayJobs(currentJobs);

            console.log(`Dismissed job at index ${index}. ${currentJobs.length} jobs remaining.`);
        }

        async function addAsClient(index) {
            console.log('addAsClient called with index:', index);
            console.log('currentJobs array:', currentJobs);
            console.log('currentJobs.length:', currentJobs ? currentJobs.length : 'undefined');
            console.log('currentJobs[index]:', currentJobs ? currentJobs[index] : 'undefined');

            const job = currentJobs[index];

            // Validate job object
            if (!job) {
                console.error(`Job not found at index ${index}. currentJobs has ${currentJobs ? currentJobs.length : 0} items`);
                alert(`‚ùå Error: Job data not found (Index: ${index}, Total jobs: ${currentJobs ? currentJobs.length : 0})`);
                return;
            }
            
            // Show modal
            const modal = document.getElementById('analysisModal');
            const content = document.getElementById('analysisContent');
            modal.classList.add('active');
            content.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Step 1/2: Fetching full job details...</p>
                </div>
            `;

            try {
                // First, fetch full job details if we only have basic info
                let jobText = job.description || job.title || '';

                // Fetch full details if:
                // 1. We have a URL AND
                // 2. (No description OR description is same as title OR description is very short < 50 chars OR description looks like just a company name)
                const needsFullDetails = job.url && (
                    !jobText ||
                    jobText === job.title ||
                    jobText.length < 50 ||
                    jobText === job.company ||
                    jobText.includes('[Quick scan')
                );

                if (needsFullDetails) {
                    console.log(`Fetching full details for job with URL: ${job.url}`);
                    content.innerHTML = `
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Step 1/3: Scraping full job posting...</p>
                        </div>
                    `;

                    const detailResponse = await fetch('/api/scrape-single', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url: job.url })
                    });

                    const detailData = await detailResponse.json();
                    if (detailData.success && detailData.job && detailData.job.description) {
                        jobText = detailData.job.description;
                        console.log(`Fetched full description (${jobText.length} chars)`);
                    } else {
                        console.warn('Failed to fetch full job details:', detailData.error);
                        // Show warning but continue
                        content.innerHTML = `
                            <div class="alert alert-warning">
                                ‚ö†Ô∏è Warning: Could not fetch full job description. Analysis may be limited.
                                <br><small>Error: ${detailData.error || 'Unknown error'}</small>
                            </div>
                        `;
                        await new Promise(resolve => setTimeout(resolve, 2000)); // Show warning for 2 seconds
                    }
                }
                
                content.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Step 2/3: Analyzing lead and generating email/script...</p>
                    </div>
                `;
                
                // Analyze the job posting
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        posting_text: jobText,
                        posting_url: job.url,
                        company_name: job.company || 'Unknown Company',
                        job_title: job.title || 'Job Posting'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const analysis = data.lead;
                    
                    // Step 3: Save as client
                    content.innerHTML = `
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Step 3/3: Saving client to database...</p>
                        </div>
                    `;
                    
                    const clientData = {
                        company_name: analysis.company?.name || job.company || 'Unknown Company',
                        industry: analysis.company?.industry || job.location,
                        location: analysis.job_details?.location || job.location,
                        tier: analysis.lead_scoring?.tier || 'TIER 3',
                        score: analysis.lead_scoring?.total_score || 0,
                        qualification_reason: job.qualification_reason,
                        pain_points: analysis.job_details?.pain_points || [],
                        growth_indicators: job.growth_indicators || [],
                        value_prop: job.value_prop,
                        job_count: job.job_count || 1,
                        url: analysis.job_details?.url || job.url,
                        description: jobText,
                        email_draft: analysis.outreach_strategy?.email_template,
                        call_script: analysis.outreach_strategy?.call_script,
                        notes: `Added from dashboard search. Analysis: ${analysis.lead_summary || ''}`
                    };
                    
                    const saveResponse = await fetch('/api/add-client', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(clientData)
                    });
                    
                    const saveData = await saveResponse.json();
                    
                    if (saveData.success) {
                        displayClientSuccess(saveData, analysis, job);
                    } else {
                        content.innerHTML = `
                            <div class="alert alert-error">
                                ‚ùå Error saving client: ${saveData.error || 'Failed to save'}
                            </div>
                        `;
                    }
                } else {
                    content.innerHTML = `
                        <div class="alert alert-error">
                            ‚ùå Error: ${data.error || 'Failed to analyze lead'}
                        </div>
                    `;
                }
            } catch (error) {
                content.innerHTML = `
                    <div class="alert alert-error">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
            }
        }

        function displayClientSuccess(saveData, analysis, job) {
            const content = document.getElementById('analysisContent');
            
            content.innerHTML = `
                <div class="alert alert-success">
                    ‚úÖ Client successfully added to database!
                    <br><small>Client ID: ${saveData.client_id}</small>
                </div>

                <div class="analysis-section">
                    <h3>${escapeHtml(saveData.company_name)}</h3>
                    <span class="tier-badge tier-${saveData.tier.toLowerCase().replace('tier ', '')}">${saveData.tier}</span>
                    <div class="score-display">Score: ${analysis.lead_scoring?.total_score || 0}/100</div>
                </div>

                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Company</div>
                        <div class="info-value">${escapeHtml(saveData.company_name)}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Industry</div>
                        <div class="info-value">${escapeHtml(analysis.company?.industry || 'N/A')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Location</div>
                        <div class="info-value">${escapeHtml(analysis.job_details?.location || analysis.company?.location || 'N/A')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Job Title</div>
                        <div class="info-value">${escapeHtml(analysis.job_details?.title || 'N/A')}</div>
                    </div>
                </div>

                ${analysis.job_details?.pain_points && analysis.job_details.pain_points.length > 0 ? `
                    <div class="section">
                        <h4>üéØ Pain Points</h4>
                        <ul>
                            ${analysis.job_details.pain_points.map(p => `<li>${escapeHtml(p)}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}

                ${analysis.job_details?.growth_indicators && analysis.job_details.growth_indicators.length > 0 ? `
                    <div class="section">
                        <h4>üìà Growth Indicators</h4>
                        <ul>
                            ${analysis.job_details.growth_indicators.map(g => `<li>${escapeHtml(g)}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}

                ${analysis.outreach_strategy?.email_template ? `
                    <div class="section">
                        <h4>üìß Email Template</h4>
                        <div class="code-block">${escapeHtml(analysis.outreach_strategy.email_template)}</div>
                    </div>
                ` : ''}

                ${analysis.outreach_strategy?.call_script ? `
                    <div class="section">
                        <h4>üìû Call Script</h4>
                        <div class="code-block">${escapeHtml(analysis.outreach_strategy.call_script)}</div>
                    </div>
                ` : ''}

                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                    <button class="btn-primary" onclick="window.location.href='/clients'">
                        üë• View All Clients
                    </button>
                    <button class="btn-secondary" onclick="closeModal()">
                        Close
                    </button>
                </div>
            `;
        }

        function displayAnalysis(analysis) {
            const content = document.getElementById('analysisContent');
            
            content.innerHTML = `
                <div class="alert alert-success">
                    ‚úÖ Lead successfully analyzed and saved!
                </div>

                <div class="analysis-section">
                    <span class="tier-badge tier-${analysis.tier.toLowerCase().replace('tier ', '')}">${analysis.tier}</span>
                    <div class="score-display">${analysis.total_score}/30 points</div>
                </div>

                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Company</div>
                        <div class="info-value">${escapeHtml(analysis.company_name || 'N/A')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Industry</div>
                        <div class="info-value">${escapeHtml(analysis.industry || 'N/A')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Location</div>
                        <div class="info-value">${escapeHtml(analysis.location || 'N/A')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Positions</div>
                        <div class="info-value">${analysis.positions_count || 'N/A'}</div>
                    </div>
                </div>

                ${analysis.value_proposition ? `
                    <div class="analysis-section">
                        <h3>üìß Email / Value Proposition</h3>
                        <p style="line-height: 1.6; color: #333;">${escapeHtml(analysis.value_proposition)}</p>
                    </div>
                ` : ''}

                ${analysis.call_script ? `
                    <div class="analysis-section">
                        <h3>üìû Call Script</h3>
                        <p style="line-height: 1.6; color: #333; white-space: pre-wrap;">${escapeHtml(analysis.call_script)}</p>
                    </div>
                ` : ''}

                ${analysis.pain_points && analysis.pain_points.length > 0 ? `
                    <div class="analysis-section">
                        <h3>üéØ Pain Points</h3>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            ${analysis.pain_points.map(p => `<li>${escapeHtml(p)}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}

                ${analysis.needs_analysis ? `
                    <div class="analysis-section">
                        <h3>üìä Needs Analysis</h3>
                        <p style="line-height: 1.6; color: #333;">${escapeHtml(analysis.needs_analysis)}</p>
                    </div>
                ` : ''}
            `;
        }

        function closeModal() {
            document.getElementById('analysisModal').classList.remove('active');
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text ? String(text).replace(/[&<>"']/g, m => map[m]) : '';
        }

        // Close modal on outside click
        document.getElementById('analysisModal').addEventListener('click', (e) => {
            if (e.target.id === 'analysisModal') {
                closeModal();
            }
        });
    </script>
</body>
</html>
