<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forecasta Lead Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: white;
            padding: 20px 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            border-radius: 8px;
        }

        h1 {
            color: #1a1a2e;
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .subtitle {
            color: #666;
            font-size: 0.95em;
        }

        /* Two-column layout */
        .main-layout {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
            align-items: start;
        }

        /* Search Panel */
        .search-panel {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 20px;
        }

        .search-panel h2 {
            color: #1a1a2e;
            font-size: 1.3em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #333;
            font-weight: 500;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95em;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        label {
            font-size: 0.9em;
            color: #666;
            font-weight: 600;
        }

        select, input, button {
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 5px;
            font-size: 1em;
            font-family: inherit;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }

        button:hover {
            background: #5568d3;
        }

        button.secondary {
            background: #6b7280;
        }

        button.secondary:hover {
            background: #4b5563;
        }

        .leads-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .lead-card {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.2s;
        }

        .lead-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .lead-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .lead-title {
            flex: 1;
        }

        .lead-title h3 {
            color: #1f2937;
            margin-bottom: 5px;
            font-size: 1.5em;
        }

        .lead-meta {
            color: #6b7280;
            font-size: 0.9em;
        }

        .tier-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.85em;
            text-transform: uppercase;
        }

        .tier-badge.tier-1 {
            background: #d1fae5;
            color: #065f46;
        }

        .tier-badge.tier-2 {
            background: #dbeafe;
            color: #1e40af;
        }

        .tier-badge.tier-3 {
            background: #fef3c7;
            color: #92400e;
        }

        .tier-badge.tier-4 {
            background: #fee2e2;
            color: #991b1b;
        }

        .tier-badge.tier-5 {
            background: #f3f4f6;
            color: #374151;
        }

        .score-display {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-left: 20px;
        }

        .lead-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        .info-section h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-item {
            margin-bottom: 8px;
            color: #374151;
        }

        .info-item strong {
            color: #1f2937;
        }

        .pain-points {
            background: #f9fafb;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }

        .pain-point {
            padding: 10px;
            margin-bottom: 10px;
            background: white;
            border-left: 3px solid #667eea;
            border-radius: 3px;
        }

        .value-prop {
            background: #ede9fe;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            font-style: italic;
            color: #5b21b6;
        }

        .call-script {
            background: #f0fdf4;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }

        .call-script strong {
            color: #065f46;
        }

        .lead-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }

        .lead-actions button {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .status-select {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #667eea;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #6b7280;
        }

        textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 5px;
            font-family: inherit;
            font-size: 1em;
            resize: vertical;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-state h3 {
            color: #374151;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .lead-body {
                grid-template-columns: 1fr;
            }
            
            .lead-header {
                flex-direction: column;
                gap: 10px;
            }
            
            h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéØ Forecasta Lead Analysis Dashboard</h1>
            <p class="subtitle">Intelligent lead qualification for workforce forecasting</p>
        </header>

        <!-- Stats Cards -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-number" id="totalLeads">-</div>
                <div class="stat-label">Total Leads</div>
            </div>
            <div class="stat-card tier-1">
                <div class="stat-number" id="tier1Count">-</div>
                <div class="stat-label">Tier 1 - Top Priority</div>
            </div>
            <div class="stat-card tier-2">
                <div class="stat-number" id="tier2Count">-</div>
                <div class="stat-label">Tier 2 - Qualified</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgScore">-</div>
                <div class="stat-label">Average Score</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="control-group">
                <label for="tierFilter">Filter by Tier</label>
                <select id="tierFilter">
                    <option value="">All Tiers</option>
                    <option value="TIER 1">Tier 1 - Top Priority</option>
                    <option value="TIER 2">Tier 2 - Qualified</option>
                    <option value="TIER 3">Tier 3 - Monitor</option>
                    <option value="TIER 4">Tier 4 - Low Priority</option>
                    <option value="TIER 5">Tier 5 - Reject</option>
                </select>
            </div>

            <div class="control-group">
                <label for="statusFilter">Filter by Status</label>
                <select id="statusFilter">
                    <option value="">All Statuses</option>
                    <option value="new">New</option>
                    <option value="contacted">Contacted</option>
                    <option value="meeting_scheduled">Meeting Scheduled</option>
                    <option value="customer">Customer</option>
                    <option value="lost">Lost</option>
                    <option value="disqualified">Disqualified</option>
                </select>
            </div>

            <div class="control-group">
                <label for="industryFilter">Filter by Industry</label>
                <select id="industryFilter">
                    <option value="">All Industries</option>
                </select>
            </div>

            <div class="control-group">
                <label>&nbsp;</label>
                <button onclick="refreshLeads()">üîÑ Refresh</button>
            </div>

            <div class="control-group">
                <label>&nbsp;</label>
                <button class="secondary" onclick="openAnalyzeModal()">‚ûï Analyze New Posting</button>
            </div>

            <div class="control-group">
                <label>&nbsp;</label>
                <button class="secondary" onclick="exportCSV()">üì• Export CSV</button>
            </div>
        </div>

        <!-- Leads Container -->
        <div class="leads-container">
            <div id="leadsContent" class="loading">
                Loading leads...
            </div>
        </div>
    </div>

    <!-- Analyze Modal -->
    <div class="modal" id="analyzeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Analyze New Job Posting</h2>
                <button class="close-btn" onclick="closeAnalyzeModal()">&times;</button>
            </div>
            <div class="form-group">
                <label for="postingUrl">Posting URL (optional)</label>
                <input type="text" id="postingUrl" placeholder="https://craigslist.org/...">
            </div>
            <div class="form-group">
                <label for="postingText">Job Posting Text *</label>
                <textarea id="postingText" rows="10" placeholder="Paste job posting text here..."></textarea>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="analyzePosting()" style="flex: 1;">üîç Analyze</button>
                <button class="secondary" onclick="closeAnalyzeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Lead Details</h2>
                <button class="close-btn" onclick="closeDetailModal()">&times;</button>
            </div>
            <div id="detailContent"></div>
        </div>
    </div>

    <script>
        let allLeads = [];
        let currentFilters = {
            tier: '',
            status: '',
            industry: ''
        };

        // Load stats and leads on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadIndustries();
            loadLeads();

            // Set up filter event listeners
            document.getElementById('tierFilter').addEventListener('change', function() {
                currentFilters.tier = this.value;
                loadLeads();
            });

            document.getElementById('statusFilter').addEventListener('change', function() {
                currentFilters.status = this.value;
                loadLeads();
            });

            document.getElementById('industryFilter').addEventListener('change', function() {
                currentFilters.industry = this.value;
                loadLeads();
            });
        });

        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();

                document.getElementById('totalLeads').textContent = stats.total;
                document.getElementById('tier1Count').textContent = stats.tier_1;
                document.getElementById('tier2Count').textContent = stats.tier_2;
                document.getElementById('avgScore').textContent = stats.avg_score;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadIndustries() {
            try {
                const response = await fetch('/api/industries');
                const industries = await response.json();

                const select = document.getElementById('industryFilter');
                industries.forEach(industry => {
                    const option = document.createElement('option');
                    option.value = industry;
                    option.textContent = industry;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading industries:', error);
            }
        }

        async function loadLeads() {
            const container = document.getElementById('leadsContent');
            container.innerHTML = '<div class="loading">Loading leads...</div>';

            try {
                const params = new URLSearchParams();
                if (currentFilters.tier) params.append('tier', currentFilters.tier);
                if (currentFilters.status) params.append('status', currentFilters.status);
                if (currentFilters.industry) params.append('industry', currentFilters.industry);

                const response = await fetch(`/api/leads?${params}`);
                const data = await response.json();
                allLeads = data.leads;

                if (allLeads.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No leads found</h3>
                            <p>Try adjusting your filters or analyze a new job posting.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = allLeads.map(lead => renderLeadCard(lead)).join('');
            } catch (error) {
                console.error('Error loading leads:', error);
                container.innerHTML = `<div class="empty-state"><h3>Error loading leads</h3><p>${error.message}</p></div>`;
            }
        }

        function renderLeadCard(lead) {
            const company = lead.company || {};
            const scoring = lead.lead_scoring || {};
            const signals = lead.business_signals || {};
            const needs = lead.needs_analysis || {};
            const valueProps = lead.value_propositions || [];
            const callScript = lead.call_script || {};
            const tracking = lead.outcome_tracking || {};

            const tierClass = (scoring.tier || 'TIER 5').toLowerCase().replace(' ', '-');
            const painPoints = needs.primary_pain_points || [];
            const mainScript = callScript.main_script || {};

            return `
                <div class="lead-card">
                    <div class="lead-header">
                        <div class="lead-title">
                            <h3>${company.name || 'Unknown Company'}</h3>
                            <div class="lead-meta">
                                ${signals.industry || 'Unknown Industry'} ‚Ä¢ ${company.location || 'Unknown Location'}
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <span class="tier-badge ${tierClass}">${scoring.tier || 'TIER 5'}</span>
                            <div class="score-display">${scoring.final_score || 0}<span style="font-size: 0.5em; color: #6b7280;">/30</span></div>
                        </div>
                    </div>

                    <div class="lead-body">
                        <div class="info-section">
                            <h4>üìä Company Info</h4>
                            <div class="info-item"><strong>Phone:</strong> ${company.contact?.phone || 'N/A'}</div>
                            <div class="info-item"><strong>Email:</strong> ${company.contact?.email || 'N/A'}</div>
                            <div class="info-item"><strong>Website:</strong> ${company.contact?.website || 'N/A'}</div>
                            <div class="info-item"><strong>Status:</strong> ${tracking.status || 'new'}</div>
                        </div>

                        <div class="info-section">
                            <h4>üéØ Scoring Breakdown</h4>
                            <div class="info-item"><strong>Company Scale:</strong> ${scoring.category_scores?.company_scale || 0}/9</div>
                            <div class="info-item"><strong>Forecasting Pain:</strong> ${scoring.category_scores?.forecasting_pain || 0}/12</div>
                            <div class="info-item"><strong>Accessibility:</strong> ${scoring.category_scores?.accessibility || 0}/7</div>
                            <div class="info-item"><strong>Data Quality:</strong> ${scoring.category_scores?.data_quality || 0}/2</div>
                        </div>
                    </div>

                    ${painPoints.length > 0 ? `
                        <div class="pain-points">
                            <h4>üí° Key Pain Points</h4>
                            ${painPoints.slice(0, 2).map(p => `
                                <div class="pain-point">
                                    <strong>${p.pain_category}</strong><br>
                                    ${p.specific_challenge}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    ${valueProps.length > 0 ? `
                        <div class="value-prop">
                            <strong>üí¨ Value Proposition:</strong><br>
                            "${valueProps[0].text}"
                        </div>
                    ` : ''}

                    ${mainScript.diagnosis_question ? `
                        <div class="call-script">
                            <strong>üìû Opening Question:</strong><br>
                            "${mainScript.diagnosis_question}"
                        </div>
                    ` : ''}

                    <div class="lead-actions">
                        <button onclick="viewDetails('${lead.lead_id}')">üëÅÔ∏è View Full Details</button>
                        <select class="status-select" onchange="updateStatus('${lead.lead_id}', this.value)">
                            <option value="">Update Status...</option>
                            <option value="contacted" ${tracking.status === 'contacted' ? 'selected' : ''}>Contacted</option>
                            <option value="meeting_scheduled" ${tracking.status === 'meeting_scheduled' ? 'selected' : ''}>Meeting Scheduled</option>
                            <option value="customer" ${tracking.status === 'customer' ? 'selected' : ''}>Customer</option>
                            <option value="lost" ${tracking.status === 'lost' ? 'selected' : ''}>Lost</option>
                        </select>
                        <button class="secondary" onclick="addNote('${lead.lead_id}')">üìù Add Note</button>
                    </div>
                </div>
            `;
        }

        async function updateStatus(leadId, status) {
            if (!status) return;

            try {
                const response = await fetch(`/api/lead/${leadId}/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });

                if (response.ok) {
                    await loadStats();
                    await loadLeads();
                }
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Failed to update status');
            }
        }

        function addNote(leadId) {
            const note = prompt('Add a note for this lead:');
            if (!note) return;

            fetch(`/api/lead/${leadId}/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ notes: note })
            })
            .then(response => response.json())
            .then(() => {
                alert('Note added successfully');
            })
            .catch(error => {
                console.error('Error adding note:', error);
                alert('Failed to add note');
            });
        }

        async function viewDetails(leadId) {
            try {
                const response = await fetch(`/api/lead/${leadId}`);
                const lead = await response.json();

                const detailHtml = `
                    <pre style="background: #f9fafb; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 0.85em;">
${JSON.stringify(lead, null, 2)}
                    </pre>
                `;

                document.getElementById('detailContent').innerHTML = detailHtml;
                document.getElementById('detailModal').classList.add('active');
            } catch (error) {
                console.error('Error loading details:', error);
            }
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        function openAnalyzeModal() {
            document.getElementById('analyzeModal').classList.add('active');
        }

        function closeAnalyzeModal() {
            document.getElementById('analyzeModal').classList.remove('active');
        }

        async function analyzePosting() {
            const postingText = document.getElementById('postingText').value.trim();
            const postingUrl = document.getElementById('postingUrl').value.trim();

            if (!postingText) {
                alert('Please enter job posting text');
                return;
            }

            const button = event.target;
            button.disabled = true;
            button.textContent = 'üîÑ Analyzing...';

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ posting_text: postingText, posting_url: postingUrl })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Lead analyzed successfully!');
                    closeAnalyzeModal();
                    document.getElementById('postingText').value = '';
                    document.getElementById('postingUrl').value = '';
                    await loadStats();
                    await loadLeads();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error analyzing posting:', error);
                alert('Failed to analyze posting');
            } finally {
                button.disabled = false;
                button.textContent = 'üîç Analyze';
            }
        }

        function refreshLeads() {
            loadStats();
            loadLeads();
        }

        function exportCSV() {
            window.location.href = '/api/export/csv';
        }
    </script>
</body>
</html>
